var util    = namespace("util");
var gui     = namespace("gui");
var timer   = namespace("timer");

function htmlContent() {
/*HEREDOC
<head>
<style type="text/css">
body {
    margin:0; 
    padding:0; 
    border-top:1px solid #000;
}
.line {
    width : 100%;
}
.lineSelected {
    width : 100%;
}
.label {
    display:inline-block;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    margin:0; 
    padding:0; 
}
.label.left {
    width : 50%;
    padding-right:5px;
}
.label.right {
    width:45%;
    float:right;
    text-align:right;
    padding-left:5px;
}
#content {
    width : 100%; 
    height : 100%; 
    margin:0; 
    padding:0;
    overflow-x:none;
}
* {
    -webkit-user-select:none;
}
</style>
</head>
<body>
<div id="content"></div>
</body>
HEREDOC*/
}

function injectable() {
    var mSelectedIdx = -1; 
    var mElements;
    function clear() {
        document.getElementById("content").innerHTML = "";
        mElements = null;
        mSelectedIdx = -1;
    }
    function getSelected() {
        return mElements[mSelectedIdx].dataset.id;
    }
    function select(dir) {
        var l = mElements.length, element;
        if (l == 0) {
            return;
        }
        else if (mSelectedIdx == -1) {
            mSelectedIdx = 0;
        }
        else if (l > 1) {
            mElements[mSelectedIdx].className = "line";
            mSelectedIdx += dir;
            mSelectedIdx = mSelectedIdx < 0 ? (l-1) : (mSelectedIdx > l-1 ? 0 : mSelectedIdx);
        }
        else {
            return; 
        }
        element = mElements[mSelectedIdx];
        element.className = "lineSelected";
        element.scrollIntoView();
    }
    function createElement(tag, refElement, props) {
        var element, key;
        var element = document.createElement(tag);
        for (key in props) {
            element[key] = props[key];
        }
        refElement.appendChild(element);
        return element;
    }
    function update(data) {
        clear();
        var content = document.createDocumentFragment();
        mElements = data.map(function(item, i) {
            var className = "line ";
            var element = createElement("div", content, {
                className : "line",
            });
            createElement("code", element, {
                textContent : item.leftLabel || "",
                className : "label left"
            });
            createElement("code", element, {
                textContent : item.rightLabel || "", 
                className : "label right"
            });
            element.dataset.id = i;
            return element;
        });
        select();
        document.getElementById("content").appendChild(content);
    }
    function applyStyle(styles) {
        var selector, style, i, sheet, item;
        var styleSheets = document.styleSheets[0].cssRules;
        for (i=styleSheets.length - 1; i>=0; --i) {
            sheet = styleSheets[i];
            if ((style = styles[sheet.selectorText])) {
                for (selector in style) {
                    sheet.style[selector] = style[selector];
                }
            }
        }
    }
}

function getWidget() {
    var widget, wp, is, iw;
    widget = new HiddenWebView();

    widget.canFocus = false;
    widget.transparent = true;

    gui.mainBox.packStart(widget, false, false, 0);
    wp = settings.widgetPacking;
    is = wp.search(/[sS]/);
    iw = wp.indexOf("w");
    if (is > iw) {
        gui.mainBox.reorderChild(widget, is);
    }
    else {
        gui.mainBox.reorderChild(widget, is + 1);
    }
    widget.loadString(util.hereDoc(htmlContent));
    widget.inject(injectable, null, 64, true);
    return widget;
}

function Completion(args) {
    if (!args.shortcut) {
        throw new Error("Completion no shortcut defined!");
    }
    if (!args.onSelected) {
        throw new Error("Completion: onSelected not defined!");
    }

    util.mixin(this, args);

    this._startup();
}

Object.defineProperties(Completion.prototype, {
    // private
    _sigKeyPress    : { value : null,   writable : true },
    _sigKeyRelease  : { value : null,   writable : true },
    _idLabelNotify  : { value : -1,     writable : true },
    _lastText       : { value : "",     writable : true },
    _data           : { value : null,   writable : true },
    _height         : { value : 0,      writable : true }, 
    _initialData    : { value : null,   writable : true },
    _position       : { value : 0,      writable : true },
    _timer          : { value : null,   writable : true },
    _lastKeyRelease : { value : -1,     writable : true },

    _cleanup : {
        value : function() {
            var widget = Completion.widget;
            this._sigKeyRelease.disconnect();
            this._sigKeyPress.disconnect();
            gui.messageLabel.disconnect(this._idLabelNotify);
            this._idLabelNotify = -1;
            gui.messageLabel.label = "";

            widget.inject("clear()");
            widget.visible = false;
            this.onHide();

            this._height = 0;
            this._lastText = "";
            this._data = null;
            this._initialData = null;
            this._position = 0;
            this._lastKeyRelease = -1;
            if (this._timer) {
                this._timer.remove();
                this._timer = null;
            }
            util.normalMode();
        }
    }, 
    _getSelected : { 
        value : function() {
            var id = JSON.parse(Completion.widget.inject("return getSelected()"));
            var item = this._data[id]; 
            if (item) {
                this.onSelected(item);
            }
            else {
                this.onHide();
            }
        }
    },
    _doUpdate : { 
        value : function(data) {
            io.print("update");
            this._data = data;
            var widget = Completion.widget;
            if (this._data && this._data.length > 0) {
                widget.inject("update(" + JSON.stringify(this._data) + ")");
            }
            else {
                widget.inject("clear()");
            }
            if (this.height) {
                return;
            }
            var oldHeight = this._height;
            this._height = Math.min(this._data.length, this.visibleItems) * (this.fontSize + this.lineSpacing);
            if (this._height == 0)  {
                widget.visible = false;
                return;
            }
            if (oldHeight != this._height) {
                widget.heightRequest = this._height;
            }
            if (oldHeight == 0) {
                widget.visible = true;
            }
        }
    },
    _forward : {
        value : function() {
            //this._position++;
            Completion.widget.inject("select(1)");
        }
    },
    _backward : {
        value : function() {
            //this._position--;
            Completion.widget.inject("select(-1)");
        }
    },

    _onKeyPress : {
        value : function(w, e) {
            switch(e.name) {
                case "Return" : 
                    this._getSelected();
                    this._cleanup();
                    return true;
                case "Escape" : 
                    this._cleanup();
                    return true;
                case "Down" :
                case "Tab" : 
                    this._forward();
                    return true;
                case "Up" :
                case "ISO_Left_Tab" : 
                    this._backward();
                    return true;
                default : 
                    return false;
            }
        }
    },
    _onKeyRelease : { 
        value : function(w, e) {
            if (e.isModifier) {
                return;
            }
            var text = gui.entry.text.trim();
            if (this.ignoreCase) {
                text = text.toLowerCase();
            }
            if (text == this._lastText) {
                return;
            }
            if (this._timer) {
                this._timer.remove();
            }
            if (this.updateDelay > 0) {
                var self = this;
                this._timer = timer.start(this.updateDelay, function() {
                    self._doUpdate(self.onUpdate(text));
                    return false;
                });
            }
            else {
                this._doUpdate(this.onUpdate(text));
            }
            this._lastText = text;
        }
    },
    _onUpdateLabel : {
        value : function() {
            if (gui.messageLabel.label != this.label) {
                gui.messageLabel.label = this.label;
            }
            return true;
        },
    },
    _bindCallback : {
        value : function() {
            var widget = Completion.widget;
            if (Completion._lastStyle != this._styleId) {
                widget.inject("applyStyle(" + Completion._styles[this._styleId] + ")");
                Completion._lastStyle = this._styleId;
            }

            gui.messageLabel.label = this.label;
            gui.entry.visible = true;
            gui.entry.hasFocus = true;
            this._idLabelNotify = gui.messageLabel.notify("label", this._onUpdateLabel.bind(this));

            this._sigKeyPress.connect();
            this._sigKeyRelease.connect();

            this._initialData = this.onShow();
            if (this.ignoreCase) {
                this._initialData.forEach(function(item) {
                    if (item.matchAttr) {
                        item.matchAttr = item.matchAttr.toLowerCase();
                    }
                });
            }
            this._doUpdate(this._initialData);
            if (this.height) {
                widget.visible = true;
            }
        }
    }, 
    _startup : {
        value : function() {
            var styleId;
            var style = JSON.stringify({ 
                body : { 
                    "background-color" : this.bgColor || settings.normalCompletionBgColor,
                    "color" : this.fgColor || settings.normalCompletionFgColor, 
                    "font-size" : this.fontSize,
                    "font-family" : this.fontFamily,
                },
                ".lineselected" : {
                    "background-color" : this.selectedBgColor || settings.activeCompletionBgColor,   
                    "color" : this.selectedFgColor || settings.activeCompletionFgColor,
                },
                ".label.right" : {
                    "margin-right" : this.margin || "3", 
                },
                ".label.left" : {
                    "margin-left" : this.margin || "3", 
                }, 
                "#content" : {
                    "overflow-y" : this.overflow || "auto" 
                }

            });
            if (!Completion._styles.some(function(s, i) {
                if (s == style) {
                    styleId = i;
                    return true;
                }
            }, this)) {
                styleId = Completion._styles.push(style) - 1;
            }
            Object.defineProperty(this, "_styleId", { value : styleId });

            //this.renderedItems = this.renderedItems || this.visibleItems * 3;

            this._sigKeyPress   = Signal("keyPress", this._onKeyPress.bind(this));
            this._sigKeyRelease = Signal("keyRelease", this._onKeyRelease.bind(this));

            bind(this.shortcut, this._bindCallback.bind(this));

            if (this.height) {
                Completion.widget.heightRequest = this.height;
            }
            if (!this.onUpdate) {
                switch (this.match) {
                    case "lazy" : 
                        this.onUpdate = this._onUpdateLazy; break;
                    case "exact" : 
                        this.onUpdate = this._onUpdateExact; break;
                    default :
                        this.onUpdate = this._onUpdateWordMatch; break;
                }
            }
            this.onShow = this.onShow || this.onUpdate;
        }
    }, 
    _onUpdateExact : {
        value : function(text) {
            var data = this._lastText.length < text.length ? this._data : this._initialData;
            return data.filter(function(item) {
                return item.matchAttr.indexOf(text) != -1;
            });
        }
    },
    _onUpdateLazy : { 
        value : function(text) {
            var data = this._lastText.length < text.length ? this._data : this._initialData;
            return data.filter(function(item) {
                var matchAttr = item.matchAttr;
                var length = matchAttr.length;
                var tmp = text;
                for (var i=0; i<length; i++) {
                    if (tmp[0] == matchAttr[i]) {
                        tmp = tmp.substring(1);
                    }
                    if (!tmp) {
                        return true;
                    }
                }
                return false;
            });
        } 
    },
    _onUpdateWordMatch : {
        value : function(text) {
            var data = this._lastText.length < text.length ? this._data : this._initialData;
            var words = text.split(/\s+/);
            return data.filter(function(item) {
                return words.every(function(word) {
                    return item.matchAttr.indexOf(word) != -1;
                });
            });
        }
    },
    // public overridable properties
    onUpdate        : { value : null,           writable : true },
    onSelected      : { value : null,           writable : true },
    shortcut        : { value : null,           writable : true }, 
    label           : { value : ":",            writable : true }, 
    visibleItems    : { value : 11,             writable : true },
    fontSize        : { value : 11,             writable : true },
    fontFamily      : { value : "monospace",    writable : true },
    lineSpacing     : { value : 2,              writable : true },
    onHide          : { value : function(){},   writable : true }, 
    ignoreCase      : { value : true,           writable : true }, 
    updateDelay     : { value : 0,              writable : true }, 
});

Object.defineProperties(Completion, {
    _lastStyle : {
        value : -1, writable : true
    },
    _styles : {
        value : []
    },
    widget : { 
        value : getWidget() 
    } 
});

return Completion;
/* vim: set ft=javascript: */
